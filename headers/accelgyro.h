/*
 * accel.h
 *
 * Created: 2015-11-04 18:40:20
 *  Author: remy
 */ 


#ifndef ACCEL_H_
#define ACCEL_H_

#ifndef F_CPU
#define F_CPU 16000000L
#endif

#include <stdint.h>
#include <avr/pgmspace.h>
#include <avr/interrupt.h>
#include "accel_registers.h"
#include "helper_3dmath.h"

/************************************************************************/
/* @brief clk selection different values                              */
/************************************************************************/
enum CLK_SEL {
    INTERNAL,
    PLL_X_GYRO,
    PLL_Y_GYRO,
    PLL_Z_GYRO,
    PLL_EXT_32,
    PLL_EXT_19,
    RESERVED,
    STOP
};

/************************************************************************/
/* @brief digital low pass filter config values                         */
/************************************************************************/
enum DLPF_CFG {
    DLPF_0,
    DLPF_1,
    DLPF_2,
    DLPF_3,
    DLPF_4,
    DLPF_5,
    DLPF_6
};

/************************************************************************/
/* @brief accelerometer available range values                          */
/************************************************************************/
enum ACCEL_RANGE {
    ACCEL_G2,
    ACCEL_G4,
    ACCEL_G5,
    ACCEL_G6    
};

/************************************************************************/
/* @brief gyroscope available range values                              */
/************************************************************************/
enum GYRO_RANGE {
    GYRO_DEG_250,
    GYRO_DEG_500,
    GYRO_DEG_1000,
    GYRO_DEG_2000
};

/************************************************************************/
/* @brief FIFO enable register available values                         */
/************************************************************************/
enum FIFO_ENABLE {
    SLV0_FIFO_EN   = 1,
    SLV1_FIFO_EN   = 2,
    SLV2_FIFO_EN   = 4,
    ACCEL_FIFO_EN  = 8,
    GYRO_Z_FIFO_EN = 16,
    GYRO_Y_FIFO_EN = 32,
    GYRO_X_FIFO_EN = 64,
    TEMP_FIFO_EN   = 128
};

/************************************************************************/
/* @brief MPU available interruption sources                            */
/************************************************************************/
enum INT_EN_SRC {
    DATA_READY = 1,
    DMP        = 2,
    PLL        = 4,
    MASTER     = 8,
    FIFO_OFLOW = 16    
};

/************************************************************************/
/* @brief interrupt flag from MPU                                       */
/************************************************************************/
volatile uint8_t interrupt_accel_flag;

/************************************************************************/
/* @brief clear interrupt flag from register                            */
/************************************************************************/
void clear_interrupt_accel_flag();

/************************************************************************/
/* @brief configure the MPU 6050 basic features                         */
/************************************************************************/
void configure_accelgyro();

/************************************************************************/
/* @brief configure the DMP                                             */
/************************************************************************/
void configure_dmp();

/************************************************************************/
/* @brief test connection with a who am i                               */
/************************************************************************/
uint8_t test_connection();

/************************************************************************/
/* @brief call test_connection, configure_accelgyro and configure_dmp   */
/************************************************************************/
uint8_t initialize_accelgyro();

/************************************************************************/
/* @brief set sample rate register                                      */
/************************************************************************/
void set_sample_rate(uint8_t value);

/************************************************************************/
/* @brief ake/sleep device                                              */
/************************************************************************/
void set_sleep_mode(uint8_t enable);

/************************************************************************/
/* @brief select clock source                                           */
/************************************************************************/
void set_clk_selection(enum CLK_SEL clk_value);

/************************************************************************/
/* @brief select DLPF bandwidth                                         */
/************************************************************************/
void set_dlpf(enum DLPF_CFG dlpf_value);

/************************************************************************/
/* @brief configure fsync pin behavior                                  */
/************************************************************************/
void set_fsync_config(uint8_t value);

/************************************************************************/
/* @brief set accelerometer range                                       */
/************************************************************************/
void set_accel_range(enum ACCEL_RANGE range_value);

/************************************************************************/
/* @brief set gyroscope range                                           */
/************************************************************************/
void set_gyro_range(enum GYRO_RANGE range_value);

/************************************************************************/
/* @brief configure FIFO enable register                                */
/************************************************************************/
void set_fifo_enable_for(enum FIFO_ENABLE fifo_value);

/************************************************************************/
/* @brief enable FIFO operations in user control register               */
/************************************************************************/
void set_fifo_enabled(uint8_t enable);

/************************************************************************/
/* @brief reset FIFO buffer                                             */
/************************************************************************/
void reset_fifo();

/************************************************************************/
/* @brief perform a full reset of device                                */
/************************************************************************/
void reset_device();

/************************************************************************/
/* @brief enable interrupt for specific sources (see INT_EN_SRC enum)   */
/************************************************************************/
void interrupt_enable(enum INT_EN_SRC enable_from);

/************************************************************************/
/* @brief clear the OTP bank flag (??)                                  */
/************************************************************************/
void set_otp_bank_flag(uint8_t enable);

/************************************************************************/
/* @brief return fifo count                                             */
/************************************************************************/
uint16_t get_fifo_count();

/************************************************************************/
/* @brief read FIFO buffer                                              */
/************************************************************************/
void get_fifo_bytes(uint8_t* bytes, uint8_t length);

/************************************************************************/
/* @brief get accelerometer x,y and z                                   */
/************************************************************************/

/************************************************************************/
/* @brief get gyro x, y and z values                                    */
/************************************************************************/

/************************************************************************/
/* @brief configure interrupt behavior                                  */
/************************************************************************/
void configure_interrupt();

/************************************************************************/
/* @brief read interrupt status register                                */
/************************************************************************/
void get_int_status(uint8_t* data);

/************************************************************************/
/* @brief enable/disable i2c master mode for the chip                   */
/************************************************************************/
void set_master_mode_enabled(uint8_t enable);

/************************************************************************/
/* @brief reset i2c master mode                                         */
/************************************************************************/
void reset_master_mode();

/************************************************************************/
/* DMP memory functions - taken from J Rowberg I2C devlib               */
/* and Davide Gironi MPU6050 Lib thanks to them                         */
/************************************************************************/

/************************************************************************/
/* @brief enable/disable DMP                                            */
/************************************************************************/
void set_dmp_enabled(uint8_t enable);

/************************************************************************/
/* @brief reset DMP                                                     */
/************************************************************************/
void reset_dmp();

/************************************************************************/
/* @brief set a chip memory bank.                                       */
/************************************************************************/
void set_memory_bank(uint8_t bank, uint8_t prefetch_enabled, uint8_t in_user_bank);

/************************************************************************/
/* @brief set DMP memory start address                                  */
/************************************************************************/
void set_memory_start_address(uint8_t address);

/************************************************************************/
/* @brief read a block of memory from DMP                               */
/************************************************************************/
void read_memory_block(uint8_t *data, uint16_t data_size, uint8_t bank, uint8_t address);

/************************************************************************/
/* @brief write a chunk in memory                                       */
/************************************************************************/
uint8_t write_memory_block(const uint8_t *data, uint16_t data_size, uint8_t bank, uint8_t address, uint8_t verify, uint8_t use_prog_mem);

/************************************************************************/
/* @brief write DMP config set (see source file for data etc..          */
/************************************************************************/
uint8_t write_dmp_configuration_set(const uint8_t* data, uint16_t data_size, uint8_t use_prog_mem);

/************************************************************************/
/* @brief get quaternion values from FIFO                               */
/************************************************************************/
void get_quaternion_values_from_fifo(int16_t* data, const uint8_t* packet);

/************************************************************************/
/* @brief build a quaternion from FIFO values                           */
/************************************************************************/
void get_quaternion(Quaternion* quaternion , const uint8_t* packet);

/************************************************************************/
/* @brief get gravity from quaternion into vector                       */
/************************************************************************/
void dmp_get_gravity(VectorFloat* vectorfloat, Quaternion* quaternion);

/************************************************************************/
/* @brief finally get Yaw/Pitch/Roll angles                             */
/************************************************************************/
void dmp_get_ypr(float* data, Quaternion* quaternion, VectorFloat* gravity);

#endif /* ACCEL_H_ */